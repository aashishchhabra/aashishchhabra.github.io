<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Deploying Apache Kafka Part 1" /><meta property="og:locale" content="en" /><meta name="description" content="What is Apache Kafka Apache Kafka is an open source event streaming tool that is similar to multiple publish / subscribe tools available but its popularity has been growing due to multiple large scale organizations using Kafka to drive their event driven systems. This article won’t be covering details of Apache Kafka and will concentrate on deploying Apache kafka on linux systems in cluster mode with some basic configurations." /><meta property="og:description" content="What is Apache Kafka Apache Kafka is an open source event streaming tool that is similar to multiple publish / subscribe tools available but its popularity has been growing due to multiple large scale organizations using Kafka to drive their event driven systems. This article won’t be covering details of Apache Kafka and will concentrate on deploying Apache kafka on linux systems in cluster mode with some basic configurations." /><link rel="canonical" href="https://aashishchhabra.github.io/posts/deploying-apache-kafka-part-1/" /><meta property="og:url" content="https://aashishchhabra.github.io/posts/deploying-apache-kafka-part-1/" /><meta property="og:site_name" content="Aashish Chhabra" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-04-21T00:08:00+05:30" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Deploying Apache Kafka Part 1" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-04-21T02:48:53+05:30","datePublished":"2022-04-21T00:08:00+05:30","description":"What is Apache Kafka Apache Kafka is an open source event streaming tool that is similar to multiple publish / subscribe tools available but its popularity has been growing due to multiple large scale organizations using Kafka to drive their event driven systems. This article won’t be covering details of Apache Kafka and will concentrate on deploying Apache kafka on linux systems in cluster mode with some basic configurations.","headline":"Deploying Apache Kafka Part 1","mainEntityOfPage":{"@type":"WebPage","@id":"https://aashishchhabra.github.io/posts/deploying-apache-kafka-part-1/"},"url":"https://aashishchhabra.github.io/posts/deploying-apache-kafka-part-1/"}</script><title>Deploying Apache Kafka Part 1 | Aashish Chhabra</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Aashish Chhabra"><meta name="application-name" content="Aashish Chhabra"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /avatar.jpg " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Aashish Chhabra</a></div><div class="site-subtitle font-italic">Technology Enthusiast and Always Eager to Learn</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/aashishchhabra" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['mail','aashishchhabra.in'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Deploying Apache Kafka Part 1</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Deploying Apache Kafka Part 1</h1><div class="post-meta text-muted"><div> By <em> <a href="https://github.com/aashishchhabra">Aashish</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1650479880" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-04-21 </em> </span> <span> Updated <em class="timeago" data-ts="1650489533" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-04-21 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1175 words"> <em>6 min</em> read</span></div></div></div><div class="post-content"><h2 id="what-is-apache-kafka"><span class="mr-2">What is Apache Kafka</span><a href="#what-is-apache-kafka" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Apache Kafka is an open source event streaming tool that is similar to multiple publish / subscribe tools available but its popularity has been growing due to multiple large scale organizations using Kafka to drive their event driven systems. This article won’t be covering details of Apache Kafka and will concentrate on deploying Apache kafka on linux systems in cluster mode with some basic configurations.</p><h2 id="setting-up-the-infrastructure"><span class="mr-2">Setting up the infrastructure</span><a href="#setting-up-the-infrastructure" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>I will be using Google Cloud VM instances to create a 3 node cluster setup with 1 node for ansible controller which can be easily done even if you have Free Credits from Google. Steps for creating a GCP account with free credits can be easily found on multiple websites.</p><p>Below is the mentioned configuration of VM instances (total 4 VMs):<br /> Machine Series: N2<br /> Machine Type: n2-standard-2<br /> vCPU: 2<br /> Memory: 8 GB<br /> Operating System: CentOS 7</p><p>Once you have 4 VM instances deployed either on GCP or platform of your choice, lets start with some steps:</p><ol><li>Setup Passwordless SSH from ansible controller node to other nodes.<li>Install Ansible controller node<div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>ssh node4
yum <span class="nb">install</span> <span class="nt">-y</span> ansible
</pre></table></code></div></div><li>Create hosts file for ansible inventory as below<div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="o">[</span>kafka]
node1
node2
node3

<span class="o">[</span>zoo]
node1
node2
node3

<span class="o">[</span>ansible]
node4
</pre></table></code></div></div><li>Install Java<div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>ansible <span class="nt">-i</span> hosts kafka <span class="nt">-m</span> yum <span class="nt">-a</span> <span class="s2">"name=java-11-openjdk state=present"</span> <span class="nt">-b</span>
</pre></table></code></div></div></ol><h2 id="download-and-distribute-software-package"><span class="mr-2">Download and distribute software package</span><a href="#download-and-distribute-software-package" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Apache Kafka’s latest release as well as older releases can be downloaded from the below link: <a href="https://kafka.apache.org/downloads">Apache Kafka Downloads</a></p><p>We will be using Apache Kafka 3.1.0 for our setup. Once the pre-requisites are completed, proceed with the below steps:</p><ol><li>Download archive<div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>wget https://dlcdn.apache.org/kafka/3.1.0/kafka_2.13-3.1.0.tgz
</pre></table></code></div></div><li>Distribute and extract the package on kafka nodes<div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>ansible <span class="nt">-i</span> hosts kafka <span class="nt">-m</span> unarchive <span class="nt">-a</span> <span class="s2">"src=kafka_2.13-3.1.0.tgz dest=/opt/"</span> <span class="nt">-b</span>
ansible <span class="nt">-i</span> hosts kafka <span class="nt">-m</span> shell <span class="nt">-a</span> <span class="s2">"cd /opt/; ln -s kafka_2.13-3.1.0 kafka"</span> <span class="nt">-b</span>
</pre></table></code></div></div></ol><h2 id="configuration-setup-for-zookeeper"><span class="mr-2">Configuration setup for Zookeeper</span><a href="#configuration-setup-for-zookeeper" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>With Kafka 2.8 Kraft was introduced to replace Zookeeper’s requirement in setting up the Kafka clusters but it is still not advised to be used in Production clusters. So, we will be going ahead with setup of zookeeper for storing Kafka’s metadata.</p><ol><li>Create zookeeper user<div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>ansible <span class="nt">-i</span> hosts zoo <span class="nt">-m</span> shell <span class="nt">-a</span> <span class="s2">"groupadd kafka"</span> <span class="nt">-b</span>
ansible <span class="nt">-i</span> hosts zoo <span class="nt">-m</span> shell <span class="nt">-a</span> <span class="s2">"useradd zookeeper -g kafka"</span> <span class="nt">-b</span>
</pre></table></code></div></div><li>Create zookeeper.properties file on the ansible node<div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="nv">dataDir</span><span class="o">=</span>/zoodata/zookeeper
<span class="nv">clientPort</span><span class="o">=</span>2181
<span class="nv">maxClientCnxns</span><span class="o">=</span>0
admin.enableServer<span class="o">=</span><span class="nb">true
</span>admin.serverPort<span class="o">=</span>4888
<span class="nv">initLimit</span><span class="o">=</span>5
<span class="nv">syncLimit</span><span class="o">=</span>2
<span class="nv">tickTime</span><span class="o">=</span>2000
server.1<span class="o">=</span>node1:2888:3888
server.2<span class="o">=</span>node2:2888:3888
server.3<span class="o">=</span>node3:2888:3888
</pre></table></code></div></div><li>Distribute the zookeeper.properties file to all the zookeeper nodes<div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>ansible <span class="nt">-i</span> hosts zoo <span class="nt">-m</span> copy <span class="nt">-a</span> <span class="s2">"src=zookeeper.properties dest=/etc/zookeeper/conf/ mode=0644 owner=zookeeper group=kafka"</span> <span class="nt">-b</span>
</pre></table></code></div></div><li>Create the required log and data directories<div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>ansible <span class="nt">-i</span> hosts zoo <span class="nt">-m</span> shell <span class="nt">-a</span> <span class="s2">"mkdir -p /zoodata/zookeeper"</span> <span class="nt">-b</span>
ansible <span class="nt">-i</span> hosts zoo <span class="nt">-m</span> shell <span class="nt">-a</span> <span class="s2">"mkdir -p /var/log/zookeeper"</span> <span class="nt">-b</span>
</pre></table></code></div></div><p>/zoodata symbolises a mount point that is used to store zookeeper znodes’ data.</p><li>Create the myid file on each node and add unique id on each hosts<div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>ansible <span class="nt">-i</span> hosts zoo <span class="nt">-m</span> shell <span class="nt">-a</span> <span class="s2">"touch /zoodata/zookeeper/myid"</span> <span class="nt">-b</span>
ansible <span class="nt">-i</span> hosts zoo <span class="nt">-m</span> shell <span class="nt">-a</span> <span class="s2">"echo 1 &gt; /zoodata/zookeeper/myid"</span> <span class="nt">-b</span> <span class="nt">--limit</span> node1
ansible <span class="nt">-i</span> hosts zoo <span class="nt">-m</span> shell <span class="nt">-a</span> <span class="s2">"echo 2 &gt; /zoodata/zookeeper/myid"</span> <span class="nt">-b</span> <span class="nt">--limit</span> node2
ansible <span class="nt">-i</span> hosts zoo <span class="nt">-m</span> shell <span class="nt">-a</span> <span class="s2">"echo 3 &gt; /zoodata/zookeeper/myid"</span> <span class="nt">-b</span> <span class="nt">--limit</span> node3
</pre></table></code></div></div><li>Create a systemd file zookeeper.service with the below contents<div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="o">[</span>Unit]
<span class="nv">Description</span><span class="o">=</span>Apache ZooKeeper Service
<span class="nv">Documentation</span><span class="o">=</span>http://zookeeper.apache.org
<span class="nv">Requires</span><span class="o">=</span>network.target
<span class="nv">After</span><span class="o">=</span>network.target
   
<span class="o">[</span>Service]
<span class="nv">Type</span><span class="o">=</span>simple
<span class="nv">User</span><span class="o">=</span>zookeeper
<span class="nv">Group</span><span class="o">=</span>kafka
<span class="nv">Environment</span><span class="o">=</span><span class="s2">"KAFKA_HEAP_OPTS=-Xmx1g -Xms1g"</span>
<span class="nv">Environment</span><span class="o">=</span><span class="nv">LOG_DIR</span><span class="o">=</span>/var/log/zookeeper
<span class="nv">ExecStart</span><span class="o">=</span>/opt/kafka/bin/zookeeper-server-start.sh /etc/zookeeper/conf/zookeeper.properties
<span class="nv">ExecStop</span><span class="o">=</span>/opt/kafka/bin/zookeeper-server-stop.sh /etc/zookeeper/conf/zookeeper.properties
   
<span class="o">[</span>Install]
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</pre></table></code></div></div><li>Distribute the systemd file on all hosts<div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>ansible <span class="nt">-i</span> hosts zoo <span class="nt">-m</span> copy <span class="nt">-a</span> <span class="s2">"src=zookeeper.service dest=/etc/systemd/system/ mode=0644"</span> <span class="nt">-b</span>
</pre></table></code></div></div><li>Change Ownership of required files and directories<div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>ansible <span class="nt">-i</span> hosts zoo <span class="nt">-m</span> shell <span class="nt">-a</span> <span class="s2">"chown -R zookeeper:kafka /zoodata/zookeeper"</span> <span class="nt">-b</span>
ansible <span class="nt">-i</span> hosts zoo <span class="nt">-m</span> shell <span class="nt">-a</span> <span class="s2">"chown -R zookeeper:kafka /var/log/zookeeper"</span> <span class="nt">-b</span>
ansible <span class="nt">-i</span> hosts kafka <span class="nt">-m</span> shell <span class="nt">-a</span> <span class="s2">"chown -R kafka:kafka /opt/kafka/*"</span> <span class="nt">-b</span>
</pre></table></code></div></div><li>Start the zookeeper service<div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>   ansible <span class="nt">-i</span> hosts zoo <span class="nt">-m</span> shell <span class="nt">-a</span> <span class="s2">"systemctl enable zookeeper; systemctl start zookeeper"</span>
</pre></table></code></div></div></ol><h2 id="configuration-setup-for-kafka"><span class="mr-2">Configuration setup for Kafka</span><a href="#configuration-setup-for-kafka" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Once the zookeeper quorum is achieved and we are able to test its functionality , we will be proceeding with Kafka’s configuration settings and systemd service creation for easy management of the cluster.</p><ol><li>Create Kafka user<div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>ansible <span class="nt">-i</span> hosts kafka <span class="nt">-m</span> shell <span class="nt">-a</span> <span class="s2">"useradd kafka -g kafka"</span> <span class="nt">-b</span>
</pre></table></code></div></div><li>Create server.properties file on ansible node<div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre>broker.id.generation.enable<span class="o">=</span><span class="nb">true
</span><span class="nv">port</span><span class="o">=</span>9092
controlled.shutdown.enable<span class="o">=</span><span class="nb">true
</span>controlled.shutdown.max.retries<span class="o">=</span>2
group.max.session.timeout.ms<span class="o">=</span>1800000
group.min.session.timeout.ms<span class="o">=</span>6000
<span class="nv">listeners</span><span class="o">=</span>PLAINTEXT://:9092
num.network.threads<span class="o">=</span>3
num.io.threads<span class="o">=</span>8
socket.send.buffer.bytes<span class="o">=</span>102400
socket.receive.buffer.bytes<span class="o">=</span>102400
socket.request.max.bytes<span class="o">=</span>104857600
log.dirs<span class="o">=</span>/kafka/kafka-logs
num.partitions<span class="o">=</span>1
num.recovery.threads.per.data.dir<span class="o">=</span>1
offsets.topic.replication.factor<span class="o">=</span>3
transaction.state.log.replication.factor<span class="o">=</span>3
transaction.state.log.min.isr<span class="o">=</span>2
log.retention.hours<span class="o">=</span>168
log.segment.bytes<span class="o">=</span>1073741824
log.retention.check.interval.ms<span class="o">=</span>300000
zookeeper.connect<span class="o">=</span>node1:2181,node2:2181,node3:2181
zookeeper.connection.timeout.ms<span class="o">=</span>18000
group.initial.rebalance.delay.ms<span class="o">=</span>0
</pre></table></code></div></div><li>Distribute the server.properties file to all the kafka broker nodes<div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>ansible <span class="nt">-i</span> hosts kafka <span class="nt">-m</span> copy <span class="nt">-a</span> <span class="s2">"src=server.properties dest=/etc/kafka/conf/ mode=0644 owner=kafka group=kafka"</span> <span class="nt">-b</span>
</pre></table></code></div></div><li>Create the log and data directories<div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>ansible <span class="nt">-i</span> hosts kafka <span class="nt">-m</span> shell <span class="nt">-a</span> <span class="s2">"mkdir -p /var/log/kafka"</span> <span class="nt">-b</span>
ansible <span class="nt">-i</span> hosts kafka <span class="nt">-m</span> shell <span class="nt">-a</span> <span class="s2">"mkdir -p /kafka/kafka-logs"</span> <span class="nt">-b</span>
</pre></table></code></div></div><p>/kafka symbolises a mount point that is used to store kafka message log files. We can have multiple such mounts and each mount needs to be added in the server.properties file.</p><li>Create systemd file kafka.service with the below contents<div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="o">[</span>Unit]
<span class="nv">Description</span><span class="o">=</span>Apache Kafka Broker
<span class="nv">Documentation</span><span class="o">=</span>https://kafka.apache.org/documentation.html
<span class="nv">Requires</span><span class="o">=</span>network.target
<span class="nv">After</span><span class="o">=</span>network.target
   
<span class="o">[</span>Service]
<span class="nv">Type</span><span class="o">=</span>simple
<span class="nv">User</span><span class="o">=</span>kafka
<span class="nv">Group</span><span class="o">=</span>kafka
<span class="nv">Environment</span><span class="o">=</span><span class="s2">"JMX_PORT=9999"</span>
<span class="nv">Environment</span><span class="o">=</span><span class="s2">"KAFKA_HEAP_OPTS=-Xmx4g -Xms4g"</span>
<span class="nv">Environment</span><span class="o">=</span><span class="nv">LOG_DIR</span><span class="o">=</span>/var/log/kafka
<span class="nv">Environment</span><span class="o">=</span><span class="s2">"KAFKA_JMX_OPTS=-Djava.rmi.server.hostname=0.0.0.0 -Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port=9999 -Dcom.sun.management.jmxremote.rmi.port=9999 -Dcom.sun.management.jmxremote.local.only=false -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false -Djava.net.preferIPv4Stack=true"</span>
<span class="nv">ExecStart</span><span class="o">=</span>/opt/kafka/bin/kafka-server-start.sh /etc/kafka/conf/server.properties
<span class="nv">ExecStop</span><span class="o">=</span>/opt/kafka/bin/kafka-server-stop.sh
<span class="nv">LimitNOFILE</span><span class="o">=</span>100000
<span class="nv">TimeoutStopSec</span><span class="o">=</span>180
<span class="nv">Restart</span><span class="o">=</span>on-failure
   
<span class="o">[</span>Install]
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</pre></table></code></div></div><li>Distribute the systemd file on all hosts<div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>ansible <span class="nt">-i</span> hosts kafka <span class="nt">-m</span> copy <span class="nt">-a</span> <span class="s2">"src=kafka.service dest=/etc/systemd/system/ mode=0644"</span> <span class="nt">-b</span>
</pre></table></code></div></div><li>Change the ownership of files and directories<div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>ansible <span class="nt">-i</span> hosts kafka <span class="nt">-m</span> shell <span class="nt">-a</span> <span class="s2">"chown -R kafka:kafka /var/log/kafka"</span> <span class="nt">-b</span>
ansible <span class="nt">-i</span> hosts kafka <span class="nt">-m</span> shell <span class="nt">-a</span> <span class="s2">"chown -R kafka:kafka /kafka/kafka-logs"</span> <span class="nt">-b</span>
</pre></table></code></div></div><li>Start the Kafka service<div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>ansible <span class="nt">-i</span> hosts kafka <span class="nt">-m</span> shell <span class="nt">-a</span> <span class="s2">"systemctl enable kafka; systemctl start kafka"</span> <span class="nt">-b</span>
</pre></table></code></div></div></ol><h2 id="test-the-kafka-cluster-setup"><span class="mr-2">Test the kafka cluster setup</span><a href="#test-the-kafka-cluster-setup" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>We can use below set of commands to test if we are able to produce and consume messages from the newly created kafka cluster.</p><ol><li>Create test topic<div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>kafka-topics <span class="nt">--bootstrap-server</span> node1:9092,node2:9092,node3:9092 <span class="nt">--create</span> <span class="nt">--topic</span> testTopic <span class="nt">--replication-factor</span> 3 <span class="nt">--partitions</span> 4
</pre></table></code></div></div><li>Start a kafka console producer<div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>   kafka-console-producer <span class="nt">--bootstrap-server</span> node1:9092,node2:9092,node3:9092 <span class="nt">--topic</span> testTopic
</pre></table></code></div></div><p>Enter some messages on the console and then exit the console with Ctrl+C</p><li>Start a kafka console consumer<div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>kafka-console-consumer <span class="nt">--bootstrap-server</span> node1:9092,node2:9092,node3:9092 <span class="nt">--topic</span> testTopic <span class="nt">--from-beginning</span>
</pre></table></code></div></div><p>You should be able to see the messages that you entered in producer</p></ol><p>Now we have a fully functional Kafka cluster. All the above steps can also be completed using ansible playbook easily to setup the cluster.</p><p>In the next part of this blog we will be installing MIT KDC, securing the Kafka clusters with kerberos, Enabling ACLs on topics etc.</p><p>NOTE: I do not own any copyrights to mention any trademark products so any such reference should only be considered as part of educational references only.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/knowledge-base/'>Knowledge Base</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/kafka/" class="post-tag no-text-decoration" >kafka</a> <a href="/tags/cluster-setup/" class="post-tag no-text-decoration" >cluster setup</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Deploying Apache Kafka Part 1 - Aashish Chhabra&amp;url=https://aashishchhabra.github.io/posts/deploying-apache-kafka-part-1/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Deploying Apache Kafka Part 1 - Aashish Chhabra&amp;u=https://aashishchhabra.github.io/posts/deploying-apache-kafka-part-1/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://aashishchhabra.github.io/posts/deploying-apache-kafka-part-1/&amp;text=Deploying Apache Kafka Part 1 - Aashish Chhabra" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/deploying-apache-kafka-part-1/">Deploying Apache Kafka Part 1</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/cluster-setup/">cluster setup</a> <a class="post-tag" href="/tags/kafka/">kafka</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div class="post-navigation d-flex justify-content-between"> <span class="btn btn-outline-primary disabled" prompt="Older"><p>-</p></span> <span class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></span></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://github.com/aashishchhabra">Aashish</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/cluster-setup/">cluster setup</a> <a class="post-tag" href="/tags/kafka/">kafka</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-WYTB3BX7B8"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-WYTB3BX7B8'); }); </script>
